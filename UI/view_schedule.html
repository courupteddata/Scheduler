<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <link href='fullcalendar/core/main.css' rel='stylesheet' />
  <link href='fullcalendar/daygrid/main.css' rel='stylesheet' />

  <script src='fullcalendar/core/main.js'></script>
  <script src='fullcalendar/interaction/main.js'></script>
  <script src='fullcalendar/daygrid/main.js'></script>

  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

  <script>
    function submitEdit(form) {
      $.ajax({
        url: 'http://127.0.0.1:5000/api/v1/shift/' + form.elements[3].value,
        type: 'DELETE',
        success: function( data ) {
          $.ajax({
            url: 'http://127.0.0.1:5000/api/v1/shift',
            type: 'POST',
            contentType: 'application/json;charset=UTF-8',
            data: JSON.stringify({
              "start":form.elements[0].value,
              "end":form.elements[1].value,
              "location_id":window.location.search.match(/id=[^&]*/)[0].substr(3),
              "entity_id":form.elements[2].value
            }),
            success: function( data ) {
              alert("Shift Edited (Please refresh to view)");
              //should find some way to call calendar.render
            }
          });
        }
      });
    };
  </script>
  <script>
    function submitNew(form) {
      $.ajax({
        url: 'http://127.0.0.1:5000/api/v1/shift',
        type: 'POST',
        contentType: 'application/json;charset=UTF-8',
        data: JSON.stringify({
          "start":form.elements[0].value,
          "end":form.elements[1].value,
          "location_id":window.location.search.match(/id=[^&]*/)[0].substr(3),
          "entity_id":form.elements[2].value
        }),
        success: function( data ) {
          alert("Shift Added (Please refresh to view)");
          //should find some way to call calendar.render
        }
      });
    };
  </script>
  <script>
    function deleteShift(form) {
      $.ajax({
        url: 'http://127.0.0.1:5000/api/v1/shift/' + form.elements[3].value,
        type: 'DELETE',
        success: function( data ) {
          alert("Shift Deleted (Please refresh to view)");
          //should find some way to call calendar.render
        }
      });
    };
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');
      var location_id = window.location.search.match(/id=[^&]*/)[0].substr(3);
      var start = window.location.search.match(/start=[^&]*/)[0].substr(6);
      var end = window.location.search.match(/end=[^&]*/)[0].substr(4);
      var data;

      $.ajax({
        url: 'http://127.0.0.1:5000/api/v1/shift',
        type: 'GET',
        data: {
          "start":start,
          "end":end,
          "location_id":location_id
        },
        success: function( shifts ) {
          data = shifts.shift;
          var events = [];
          data.forEach(function(shift) {
            var employee_name;
            $.ajax({
              url: 'http://127.0.0.1:5000/api/v1/entity/' + shift.entity_id,
              type: 'GET',
              success: function( employee ) {
                employee_name = employee.entity_name;
              }
            });
            events.push({
              title: employee_name,
              start: shift.start,
              end: shift.end,
              id: shift.shift_id
            });
          });

          var calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ['dayGrid', 'interaction'],
            defaultView: 'dayGridMonth',
            editable: true,
            currentTimezone: 'local',
            eventDrop: function(info) {
              if (!confirm("Are you sure you want to move this shift to " + info.event.start.toLocaleString() + "?")) {
                info.revert();
              } else {
                var employee_id;
                $.ajax({
                  url: 'http://127.0.0.1:5000/api/v1/entity',
                  type: 'GET',
                  success: function( employees ) {
                    employees.entity.forEach(function(employee) {
                     if(info.event.title == employee.entity_name) {
                       employee_id = employee.entity_id
                     }
                   });
                   $.ajax({
                     url: 'http://127.0.0.1:5000/api/v1/shift/' + info.event.id,
                     type: 'DELETE',
                     success: function( data ) {
                       $.ajax({
                         url: 'http://127.0.0.1:5000/api/v1/shift',
                         type: 'POST',
                         contentType: 'application/json;charset=UTF-8',
                         data: JSON.stringify({
                           "start":info.event.start,
                           "end":info.event.end,
                           "location_id":window.location.search.match(/id=[^&]*/)[0].substr(3),
                           "entity_id":employee_id
                         }),
                         success: function( data ) {
                           alert("Shift Edited (Please refresh to view)");
                           //should find some way to call calendar.render
                         }
                       });
                     }
                   });
                  }
                });
              }
            },
            eventClick: function(info) {
              var tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds
              var start = (new Date(info.event.start - tzoffset)).toISOString().slice(0, 19)
              var end = (new Date(info.event.end - tzoffset)).toISOString().slice(0, 19)
              $('#start_time')[0].value = start;
              $('#end_time')[0].value = end;
              jQuery.get("http://127.0.0.1:5000/api/v1/entity", function( data ) {
                data.entity.forEach(function(employee) {
                  opt = document.createElement('option');
                  opt.appendChild( document.createTextNode(employee.entity_name) );
                  opt.value = employee.entity_id;
                  document.getElementById("employee").appendChild(opt);
                });
              });
              $('#shift_id')[0].value = info.event.id;
              $('#submit')[0].setAttribute('onclick', 'submitEdit(this.form);');
              $('#delete')[0].removeAttribute('hidden');
              $('.modal-title')[0].innerHTML = 'Edit Shift'
              $('.modal').modal();
            },
            dateClick: function(info) {
              $('#start_time')[0].value = info.dateStr + "T07:00";
              $('#end_time')[0].value = info.dateStr + "T15:00";
              jQuery.get("http://127.0.0.1:5000/api/v1/entity", function( data ) {
                data.entity.forEach(function(employee) {
                  opt = document.createElement('option');
                  opt.appendChild( document.createTextNode(employee.entity_name) );
                  opt.value = employee.entity_id;
                  document.getElementById("employee").appendChild(opt);
                });
              });
              $('#shift_id')[0].value = null;
              $('#submit')[0].setAttribute('onclick', 'submitNew(this.form);');
              $('#delete')[0].setAttribute('hidden', '');
              $('.modal-title')[0].innerHTML = 'Add Shift'
              $('.modal').modal();
            },
            header: {
              left: 'prev,next today',
              center: 'title',
            },
            events: events
          });

          calendar.render();
        }
      });
    });
    </script>
  <title>View Schedule</title>
</head>
<body>
  <a href="home.html">Home</a>
  <div class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Shift</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="start_time">Start:</label>
              <input type="datetime-local" class="form-control" id="start_time">
            </div>
            <div class="form-group">
              <label for="end_time">End:</label>
              <input type="datetime-local" class="form-control" id="end_time">
            </div>
            <div class="form-group">
              <label for="employee">Assigned Employee:</label>
              <select class="form-control" id="employee">
              </select>
            </div>
            <input type="text" id="shift_id" hidden>
            <button type="button" class="btn btn-primary" data-dismiss="modal" id="submit">Submit changes</button>
            <button type="button" class="btn btn-danger" data-dismiss="modal" id="delete" onClick="deleteShift(this.form);">Delete Shift</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div id='calendar' style="max-width: 900px; margin: 40px auto;"></div>
</body>
</html>
